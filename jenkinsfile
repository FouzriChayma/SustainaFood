pipeline {
    agent any

    stages {

        // ğŸš€ Ã‰tape 1: DÃ©marrer MongoDB avec volume persistant
        stage('Start MongoDB') {
            steps {
                script {
                    echo 'ğŸš€ Suppression ancienne instance MongoDB (si existe)...'
                    sh 'docker rm -f mongodb || true' // Supprimer ancien MongoDB

                    echo 'ğŸš€ DÃ©marrage de MongoDB avec volume persistant...'
                    sh 'docker run -d -p 27017:27017 --name mongodb -v mongo-data:/data/db mongo' // RedÃ©marrer proprement

                    echo 'â³ Attente du dÃ©marrage complet de MongoDB...'
                    sh 'sleep 10' // Laisser le temps de dÃ©marrer proprement
                }
            }
        }

        // ğŸ“¦ Ã‰tape 2: Installer les dÃ©pendances backend et frontend
        stage('Install Dependencies') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        echo 'ğŸ“¦ Installation des dÃ©pendances backend...'
                        sh 'npm install'
                    }

                    dir('sustainafood-frontend') {
                        echo 'ğŸ“¦ Installation des dÃ©pendances frontend...'
                        sh 'npm install --legacy-peer-deps'
                    }
                }
            }
        }

        // âœ… Ã‰tape 3: ExÃ©cuter les tests backend
        stage('Run Backend Unit Tests') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        echo 'ğŸš€ Lancement des tests backend (Jest + Supertest)...'
                        sh 'npm test'
                    }
                }
            }
        }

        // âœ… Ã‰tape 4: Tests frontend (optionnel)
        stage('Run Frontend Unit Tests') {
            steps {
                script {
                    dir('sustainafood-frontend') {
                        echo 'ğŸš€ Lancement des tests frontend...'
                        // sh 'npm test' // DÃ©commente si frontend tests prÃ©sents
                    }
                }
            }
        }

        // âš™ï¸ Ã‰tape 5: Build application
        stage('Build Application') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        echo 'âš™ï¸ Build backend...'
                        // sh 'npm run build' // Si nÃ©cessaire
                    }

                    dir('sustainafood-frontend') {
                        echo 'âš™ï¸ PrÃ©paration frontend...'
                        sh 'npm install @fortawesome/fontawesome-svg-core'
                        sh 'npm install @fortawesome/react-fontawesome'
                        sh 'npm install @fortawesome/free-solid-svg-icons'
                        echo 'âš™ï¸ Build frontend...'
                        sh 'npm run build'
                    }
                }
            }
        }

        // ğŸ” Ã‰tape 6: Analyse SonarQube
        stage('SonarQube Analysis') {
            steps {
                script {
                    echo 'ğŸ” Analyse SonarQube...'
                    sh 'node -v'
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv {
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }
    }
}
