pipeline {
    agent any

    environment {
        NVM_DIR = "/home/vagrant/.nvm"
    }

    stages {
        // Étape 1: Charger Node.js et NPM via NVM
        stage('Use Node and NPM') {
            steps {
                sh '''
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                nvm use 20
                '''
            }
        }

        // Étape 2: Installer les dépendances
        stage('Install Dependencies') {
            steps {
                script {
                    // Installer les dépendances du backend
                    dir('sustainafood-backend') {
                        sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                        nvm use 20
                        npm install
                        '''
                    }

                    // Installer les dépendances du frontend
                    dir('sustainafood-frontend') {
                        sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                        nvm use 20
                        npm install --legacy-peer-deps
                        '''
                    }
                }
            }
        }

        // Étape 3: Exécuter les tests unitaires
        stage('Run Unit Tests') {
            steps {
                script {
                    // Exécuter les tests unitaires du backend
                    dir('sustainafood-backend') {
                        sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                        nvm use 20
                        npm test
                        '''
                    }

                    // Exécuter les tests unitaires du frontend
                    dir('sustainafood-frontend') {
                        sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                        nvm use 20
                        npm test
                        '''
                    }
                }
            }
        }

        // Étape 4: Build de l'application
        stage('Build Application') {
            steps {
                script {
                    // Build du backend (optionnel si nécessaire)
                    dir('sustainafood-backend') {
                        sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                        nvm use 20
                        npm run build
                        '''
                    }

                    // Build du frontend
                    dir('sustainafood-frontend') {
                        sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
                        nvm use 20
                        npm run build
                        '''
                    }
                }
            }
        }
    }
}
