pipeline {
    agent any

    stages {
        // Étape 1: Récupérer le code source depuis GitHub
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/FouzriChayma/SustainaFood.git'
            }
        }

        // Étape 2: Installer les dépendances
        stage('Install Dependencies') {
            steps {
                script {
                    // Installer les dépendances du backend
                    dir('sustainafood-backend') {
                        sh 'npm install'
                    }

                    // Installer les dépendances du frontend
                    dir('sustainafood-frontend') {
                        sh 'npm install --legacy-peer-deps'
                    }
                }
            }
        }

        // Étape 3: Exécuter les tests unitaires
        stage('Run Unit Tests') {
            steps {
                script {
                    catchError(buildResult: 'UNSTABLE') { // Empêche le pipeline de s'arrêter si un test échoue
                        dir('sustainafood-backend') {
                            sh 'npm test' 
                        }
                        dir('sustainafood-frontend') {
                            sh 'npm test' 
                        }
                    }
                }
            }
        }

        // Étape 4: Build de l'application
        stage('Build Application') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        sh 'npm run build'
                    }
                    dir('sustainafood-frontend') {
                        sh 'npm run build'
                    }
                }
            }
        }

        // Étape 5: Archiver les artefacts générés
        stage('Archive Build') {
            steps {
                archiveArtifacts artifacts: '**/build/**', fingerprint: true
            }
        }
    }

    // Gestion des échecs et notification
    post {
        failure {
            echo '❌ Le pipeline a échoué. Vérifiez les logs !'
        }
        success {
            echo '✅ Build réussi avec succès !'
        }
    }
}
