pipeline {
    agent any

    stages {
        // ğŸš€ Ã‰tape 1: Lancer MongoDB en container Docker
        stage('Start MongoDB') {
            steps {
                script {
                    echo 'ğŸš€ DÃ©marrage de MongoDB en Docker...'
                    sh 'docker run -d -p 27017:27017 --name mongodb mongo'
                }
            }
        }

        // ğŸ“¦ Ã‰tape 2: Installer les dÃ©pendances backend
        stage('Install Backend Dependencies') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        echo 'ğŸ“¦ Installation des dÃ©pendances backend...'
                        sh 'npm install'
                    }
                }
            }
        }

        // âœ… Ã‰tape 3: Lancer les tests backend (Jest + Supertest)
        stage('Run Backend Unit Tests') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        echo 'ğŸš€ Lancement des tests backend (Jest + Supertest)...'
                        sh 'npm test'
                    }
                }
            }
        }

        // ğŸ›‘ Ã‰tape 4: ArrÃªter MongoDB aprÃ¨s les tests
        stage('Stop MongoDB') {
            steps {
                script {
                    echo 'ğŸ›‘ ArrÃªt de MongoDB...'
                    sh 'docker stop mongodb'
                    sh 'docker rm mongodb'
                }
            }
        }

        // âš™ï¸ Ã‰tape 5: Build Application backend + frontend (ton contenu)
        stage('Build Application') {
            steps {
                script {
                    // Build du backend (optionnel si nÃ©cessaire)
                    dir('sustainafood-backend') {
                        echo 'âš™ï¸ Build backend (si nÃ©cessaire)'
                        // DÃ©commenter si besoin de build backend
                        // sh 'npm run build'
                    }

                    // Build du frontend
                    dir('sustainafood-frontend') {
                        echo 'âš™ï¸ Installation des packages manquants pour le frontend...'
                        // VÃ©rifier et installer les packages FontAwesome manquants
                        sh 'npm install @fortawesome/fontawesome-svg-core'
                        sh 'npm install @fortawesome/react-fontawesome'
                        sh 'npm install @fortawesome/free-solid-svg-icons'

                        // Lancer le build du frontend
                        echo 'âš™ï¸ Lancement du build frontend...'
                        sh 'npm run build'
                    }
                }
            }
        }

        // ğŸ” Ã‰tape 6: Analyse SonarQube (optionnelle, dÃ©sactive si pas encore prÃªt)
        stage('SonarQube Analysis') {
            steps {
                script {
                    echo 'ğŸ” Lancement de l\'analyse SonarQube...'
                    sh 'node -v' // VÃ©rification version de Node.js

                    def scannerHome = tool 'scanner' // Outil SonarScanner (configurÃ© dans Jenkins)
                    withSonarQubeEnv {
                        // Lancer SonarQube scanner
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }
    }
}
