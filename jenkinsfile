pipeline {
    agent any

    stages {
        // Ã‰tape 1: Installation des dÃ©pendances
        stage('Install Dependencies') {
            steps {
                script {
                    // Installer les dÃ©pendances backend
                    dir('sustainafood-backend') {
                        echo 'ğŸ“¦ Installation des dÃ©pendances backend...'
                        sh 'npm install'
                    }

                    // Installer les dÃ©pendances frontend
                    dir('sustainafood-frontend') {
                        echo 'ğŸ“¦ Installation des dÃ©pendances frontend...'
                        sh 'npm install --legacy-peer-deps'
                    }
                }
            }
        }

        // Ã‰tape 2: Tests backend avec Jest & Supertest
        stage('Run Backend Unit Tests') {
            steps {
                script {
                    dir('sustainafood-backend') {
                        echo 'ğŸš€ Lancement des tests backend (Jest + Supertest)...'
                        sh 'npm test' // âœ… Lancement des tests unitaires backend
                    }
                }
            }
        }

        // (Optionnel) Ã‰tape 3: Tests frontend
        stage('Run Frontend Unit Tests') {
            steps {
                script {
                    dir('sustainafood-frontend') {
                        echo 'ğŸš€ (Optionnel) Lancement des tests frontend...'
                        // ğŸ”” DÃ©commente cette ligne si tu as des tests frontend
                        // sh 'npm test'
                    }
                }
            }
        }

        // Ã‰tape 4: Build backend et frontend
        stage('Build Application') {
            steps {
                script {
                    // (Optionnel) Build backend (si nÃ©cessaire)
                    dir('sustainafood-backend') {
                        echo 'âš™ï¸ (Optionnel) Build backend...'
                        // ğŸ”” DÃ©commente si tu as un build backend
                        // sh 'npm run build'
                    }

                    // Build frontend
                    dir('sustainafood-frontend') {
                        echo 'âš™ï¸ Build frontend et installation des packages manquants...'

                        // Installer les packages nÃ©cessaires (FontAwesome ici)
                        sh 'npm install @fortawesome/fontawesome-svg-core'
                        sh 'npm install @fortawesome/react-fontawesome'
                        sh 'npm install @fortawesome/free-solid-svg-icons'

                        // Lancer le build frontend
                        sh 'npm run build'
                    }
                }
            }
        }

        // Ã‰tape 5: Analyse SonarQube
        stage('SonarQube Analysis') {
            steps {
                script {
                    echo 'ğŸ” Lancement de l\'analyse SonarQube...'
                    sh 'node -v' // VÃ©rification version Node.js pour debug

                    def scannerHome = tool 'scanner' // DÃ©finir le scanner Sonar
                    withSonarQubeEnv {
                        // Lancer le scanner SonarQube
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }
    }
}
