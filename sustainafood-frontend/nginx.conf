# server {
#   listen 80;
#   server_name localhost;

#   location / {
#     root /usr/share/nginx/html;
#     index index.html;
#     try_files $uri /index.html;
#   }
# }
server {
    listen 80;
    server_name localhost; # Ou le nom de domaine que vous utiliserez

    # Servir les fichiers statiques du frontend React/Vite
    location / {
        root   /usr/share/nginx/html;    # Le dossier où Dockerfile copie les fichiers de /app/dist
        index  index.html index.htm;
        try_files $uri /index.html;      # Crucial pour les Single Page Applications (SPA)
                                         # Si une URL directe ne correspond pas à un fichier,
                                         # elle renvoie index.html pour que React Router gère la route.
    }

    # Rediriger les appels API vers le service backend
    # Ce bloc intercepte toutes les requêtes commençant par /api/
    location /api/ {
        # 'app' est le nom du service backend défini dans votre docker-compose.yml.
        # Docker Compose permet aux conteneurs de communiquer en utilisant les noms de service.
        # Le backend écoute sur le port 3000 à l'intérieur de son conteneur.
        proxy_pass http://app:3000/; # Le '/' final est important ici !

        # Headers importants pour que le backend reçoive les bonnes informations
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Enlève le préfixe /api/ de l'URL avant de la transmettre au backend
        # Par exemple, /api/users/login deviendra /users/login pour le backend.
        # Cette ligne est nécessaire car vos routes backend ne commencent pas par /api.
        rewrite ^/api/(.*)$ /$1 break;

        # Augmenter les timeouts si nécessaire pour des requêtes longues
        proxy_connect_timeout       600;
        proxy_send_timeout          600;
        proxy_read_timeout          600;
        send_timeout                600;
    }

    # Pages d'erreur personnalisées (optionnel mais recommandé)
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}